---
layout: post
title: "The first ECS-based objects are done"
description: >
  I've made the first entity to use the core ECS structures (asteroids), and I refactored `Transcendent` to be a component for a ship.
author: "Isaac Lichter"
image: "gooey.png"
parallax: true
---

When I wrote my last blog post, I had two pull requests that were ready for review. They were both approved, but the two branches had merge conflicts. After working out the conflicts, I put both PRs into [a new one](https://github.com/MovingBlocks/DestinationSol/pull/527), which was then merged.

Once that was done, I turned my attention to my next big goal: making ECS-based asteroids. However, I needed to accomplish another project first. In order to create a fully functioning asteroid, I needed to create a [DropsMoneyOnDeath](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/moneyDropping/components/DropsMoneyOnDeath.java) component, so that when an asteroid is destroyed, `Money` objects will be created (the same way that it already would). The `Money` creation is handled by the [MoneyDroppingSystem](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/moneyDropping/systems/MoneyDroppingSystem.java), which creates [Money](https://github.com/MovingBlocks/DestinationSol/blob/23c54ce85a1afd66d740fcb2cc90ce2a16da1848/engine/src/main/java/org/destinationsol/game/item/MoneyItem.java) whenever an entity with a `DropsMoneyOnDeath` component receives a [DestroyEvent](https://github.com/MovingBlocks/DestinationSol/blob/23c54ce85a1afd66d740fcb2cc90ce2a16da1848/engine/src/main/java/org/destinationsol/removal/DestroyEvent.java). The amount of money is scaled based on the [size](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/size/components/Size.java) of the entity. [The PR](https://github.com/MovingBlocks/DestinationSol/pull/529) is currently under review.

With that done, I was able to get started on [asteroids](https://github.com/MovingBlocks/DestinationSol/pull/531). First, I needed to design a system for creating [Money](https://github.com/MovingBlocks/DestinationSol/blob/bf6d24fb1eb65562a9baccfeb9bdde8cf71a7489/engine/src/main/java/org/destinationsol/game/item/MoneyItem.java) objects when an entity died. When an entity with a [DropsMoneyOnDeath](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/moneyDropping/components/DropsMoneyOnDeath.java) component dies, the [system](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/moneyDropping/systems/MoneyDroppingSystem.java) creates the money, scaled according to the entity's [size](https://github.com/IsaacLic/DestinationSol/blob/0c14a066affeab5fd5e8308f2021c148f32d5621/engine/src/main/java/org/destinationsol/size/components/Size.java). [The PR](https://github.com/MovingBlocks/DestinationSol/pull/529) was recently merged.

After that, I was able to start designing asteroids themselves. First, I made a [system to create an asteroid Body](https://github.com/IsaacLic/DestinationSol/blob/8abe9736787ff10e412860c50b6d478c087bd4fd/engine/src/main/java/org/destinationsol/asteroids/systems/AsteroidBodyCreationSystem.java) and a [system](https://github.com/IsaacLic/DestinationSol/blob/8abe9736787ff10e412860c50b6d478c087bd4fd/engine/src/main/java/org/destinationsol/asteroids/systems/AsteroidImpulseHandler.java) to handle [impulse events](https://github.com/MovingBlocks/DestinationSol/blob/bf6d24fb1eb65562a9baccfeb9bdde8cf71a7489/engine/src/main/java/org/destinationsol/force/events/ImpulseEvent.java) to an entity with an [asteroid component](https://github.com/IsaacLic/DestinationSol/blob/8abe9736787ff10e412860c50b6d478c087bd4fd/engine/src/main/java/org/destinationsol/asteroids/components/Asteroid.java).

Next, I added code to [SolContactListener](https://github.com/IsaacLic/DestinationSol/blob/8abe9736787ff10e412860c50b6d478c087bd4fd/engine/src/main/java/org/destinationsol/game/SolContactListener.java) (the class that handles contact) to send the [Contact](https://github.com/libgdx/libgdx/blob/5061b0c5a797cb735d5e33fec39ec6a9a6bd83f2/extensions/gdx-box2d/gdx-box2d/src/com/badlogic/gdx/physics/box2d/Contact.java) object in a [Contact event](https://github.com/MovingBlocks/DestinationSol/blob/bf6d24fb1eb65562a9baccfeb9bdde8cf71a7489/engine/src/main/java/org/destinationsol/force/events/ContactEvent.java). Asteroids don't have any special contact handling, but the new code works for every entity.

Finally, I made a [prefab](https://github.com/IsaacLic/DestinationSol/blob/8abe9736787ff10e412860c50b6d478c087bd4fd/modules/core/assets/prefabs/asteroid.prefab) for easy asteroid creation. However, the [PR](https://github.com/MovingBlocks/DestinationSol/pull/531/files) currently can't be tested, because the [gestalt library](https://github.com/MovingBlocks/gestalt) currently has issues handling empty components and components with public fields (as opposed to getters and setters). Once the next version is released, I'll test and fine-tune my PR.

After that, I moved to refactoring the `Transcendent` class. In the current structure, when a ship enters a [starport](https://github.com/MovingBlocks/DestinationSol/blob/bf6d24fb1eb65562a9baccfeb9bdde8cf71a7489/engine/src/main/java/org/destinationsol/game/StarPort.java), it is changed into a `Transcendent` object. Once it gets to the other end, it is converted back into a SolShip. With my [new PR](https://github.com/MovingBlocks/DestinationSol/pull/534/files), it'll be much simpler to handle; all it takes is an [InStarportTransit component](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/components/InStarportTransit.java) and an [EnteringStarportEvent](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/events/EnteringStarportEvent.java).

When an entity enters a starport, the `EnteringStarportEvent` sends information about the source and destination of the entity to the [system](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/systems/InTransitUpdateHandler.java) that handles the movement. That system moves the entity toward the destination every tick, when it receives an [update event](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/events/InTransitUpdateEvent.java). Then, once the entity has reached the destination, a [StarportTransitFinishedEvent](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/events/StarportTransitFinishedEvent.java) is sent to tell the system to remove the `InStarportTransit` component. While it is traveling, the [StarportTravelSystem](https://github.com/IsaacLic/DestinationSol/blob/3b3550ff9791a546e9af3fb1a46a2c6241958b7a/engine/src/main/java/org/destinationsol/Starport/systems/StarportTravelSystem.java) prevents the entity from taking any damage or colliding with anything.

The `Graphics` code still has some slight issues, so I'm going to tackle that next. After that, it's on to `SolShip`!
